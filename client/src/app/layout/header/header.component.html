<!-- Progress bar -->
@if (busyService.loading) {
  <mat-progress-bar mode="indeterminate"></mat-progress-bar>
}

<mat-sidenav-container class="h-16 md:h-20 fixed top-0 inset-x-0 z-[1000] bg-white shadow">
  <!-- Right sidenav (mobile) -->
  <mat-sidenav #drawer position="end" mode="over" [(opened)]="mobileOpen" class="w-[80vw] max-w-[420px]">
    <div class="p-4 flex items-center justify-between border-b">
      <a routerLink="/" (click)="mobileOpen=false" class="block">
        <img src="/images/logo-445.webp" alt="logo" class="h-9" />
      </a>
      <button mat-icon-button (click)="mobileOpen=false" aria-label="Close menu">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <mat-nav-list>
      <a mat-list-item routerLink="/" [routerLinkActiveOptions]="{exact:true}" routerLinkActive="active" (click)="mobileOpen=false">Home</a>
      <a mat-list-item routerLink="/shop" routerLinkActive="active" (click)="mobileOpen=false">Shop</a>
      <a mat-list-item routerLink="/test-error" routerLinkActive="active" (click)="mobileOpen=false">Test error</a>
      <a mat-list-item routerLink="/contact" routerLinkActive="active" (click)="mobileOpen=false">Contact</a>
    </mat-nav-list>

    <div class="mt-auto p-4 border-t grid gap-2">
      <a routerLink="/cart" (click)="mobileOpen=false" class="inline-flex items-center gap-2">
        <mat-icon>shopping_cart</mat-icon>
        <span>Cart ({{ cartService.itemCount() }})</span>
      </a>

      @if (accountService.currentUser()) {
        <button mat-stroked-button routerLink="/account" (click)="mobileOpen=false">Account</button>
        <button mat-stroked-button (click)="logout(); mobileOpen=false">Logout</button>
      } @else {
        <button mat-stroked-button routerLink="/account/login" (click)="mobileOpen=false">Login</button>
        <button mat-stroked-button routerLink="/account/register" (click)="mobileOpen=false">Register</button>
      }
    </div>
  </mat-sidenav>

  <mat-sidenav-content>
    <mat-toolbar class="!h-16 md:!h-20 !px-4 !bg-white">
      <!-- Left: brand -->
      <a routerLink="/" class="flex items-center">
        <img src="/images/logo-445.webp" alt="logo" class="h-10 md:h-14" />
      </a>

      <!-- Center: desktop nav -->
      <nav class="hidden md:flex items-center gap-4 mx-4 uppercase text-[1.05rem]">
        <a routerLink="/" [routerLinkActiveOptions]="{exact:true}" routerLinkActive="active">Home</a>
        <a routerLink="/shop" routerLinkActive="active">Shop</a>
        <a routerLink="/test-error" routerLinkActive="active">Test error</a>
        <a routerLink="/contact" routerLinkActive="active">Contact</a>
         <a routerLink="/upload" routerLinkActive="active">Images</a>
      </nav>

      <span class="flex-1"></span>

      <!-- Right actions -->
      <div class="flex items-center gap-2">
        <!-- Cart: always visible -->
        <a routerLink="/cart" routerLinkActive="active"
           [matBadge]="cartService.itemCount()" matBadgeSize="large"
           class="inline-flex items-center" aria-label="Cart">
          <mat-icon>shopping_cart</mat-icon>
        </a>

        <!-- Account (desktop only here) -->
        @if (accountService.currentUser()) {
          <!-- <button mat-button [matMenuTriggerFor]="userMenu" class="hidden md:inline-flex">
            <mat-icon>arrow_drop_down</mat-icon>
            <span class="hidden sm:inline">{{ accountService.currentUser()?.email }}</span>
          </button> -->
          <button mat-button [matMenuTriggerFor]="menu">
                    <mat-icon>arrow_drop_down</mat-icon>
                    <span>{{accountService.currentUser()?.email}}</span>
                </button>
        } @else {
          <button mat-stroked-button routerLink="/account/login" class="hidden md:inline-flex">Login</button>
          <button mat-stroked-button routerLink="/account/register" class="hidden md:inline-flex">Register</button>
        }

        <!-- Hamburger (mobile only) -->
        <button mat-icon-button class="md:hidden" (click)="mobileOpen = true" aria-label="Open menu">
          <mat-icon>menu</mat-icon>
        </button>
      </div>
    </mat-toolbar>
  </mat-sidenav-content>
</mat-sidenav-container>

<!-- Push page content below fixed header (adjust if your layout already adds offset) -->
<div class="h-16 md:h-20"></div>

<!-- Material account menu -->
<mat-menu #menu="matMenu" class="px-5">
    <button mat-menu-item class="px-3" routerLink="/cart">
        <mat-icon>shopping_cart</mat-icon>
        My cart
    </button>
    <button mat-menu-item class="px-3" routerLink="/orders">
        <mat-icon>history</mat-icon>
        My orders
    </button>
    <mat-divider></mat-divider>
    <button mat-menu-item class="px-3" (click)="logout()">
        <mat-icon>logout</mat-icon>
        Logout
    </button>
</mat-menu>
